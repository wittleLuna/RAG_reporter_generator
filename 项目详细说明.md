# RAG实训报告生成系统

> 基于AI的智能实训报告自动生成平台，支持多用户、模板管理、资料上传与多模式报告生成。

---

## 目录

- [项目简介](#项目简介)
- [主要功能](#主要功能)
- [系统亮点](#系统亮点)
- [技术栈与开发工具](#技术栈与开发工具)
- [系统结构](#系统结构)
- [核心代码片段](#核心代码片段)
- [快速启动](#快速启动)
- [常见问题与解决](#常见问题与解决)

---

## 项目简介

本系统面向高校/企业实训场景，结合AI大模型能力，实现一站式实训报告自动生成。用户可自定义模板，上传多种资料，系统自动融合内容并生成高质量Word报告。

---

## 主要功能

### 1. 用户系统

- 用户注册、登录、登出
- 个人信息管理（姓名、学号、班级等）
- 使用次数管理与充值（集成爱发电支付）

### 2. 模板管理

- 支持自定义封面/正文模板（.doc/.docx）
- 模板上传、选择、删除、编辑
- 占位符自动替换（如`{{name}}`、`{{report_body}}`）

### 3. 资料上传与管理

- 支持多种格式：`.md`、`.doc`、`.docx`、`.pdf`、图片等
- 拖拽上传、批量上传
- 文件顺序自定义（拖拽排序）

### 4. AI报告生成

- 支持"融合模式"与"区分模式"
- 多轮自动补全，智能扩写
- 页数控制与高级Prompt自定义
- 生成进度条与剩余次数提示

### 5. 智能插图功能（自动插入图片）

- 支持图片资料上传，自动生成图片描述
- AI会在报告正文合适位置自动插入图片占位符（如`{{image:img_1}}`）
- 支持多图片、图片描述、图片与正文内容智能关联

### 6. 报告格式自动检查与修正（Agent后处理）

- 报告生成后，自动调用大模型Agent对报告内容进行格式检查与修正
- 包括标题层级、图片占位符、列表、编号、空行、非法符号等规范化
- 保证报告结构一致、格式美观

### 7. 管理后台

- 用户管理、订单管理
- 使用次数调整、充值记录查询

### 8. 通讯功能（消息中心）

#### 1. 用户发送消息（后端API）
```python
@app.post("/messages/send")
async def send_message(
    request: Request,
    content: str = Form(None),
    image: UploadFile = File(None),
    to_user_id: int = Form(...),
    db: Session = Depends(get_db)
):
    user = get_current_user(request, db)
    if not user:
        raise HTTPException(status_code=401, detail="请先登录")
    # ...检查目标用户、保存图片、内容校验...
    msg = Message(
        from_user_id=user.id,
        to_user_id=to_user_id,
        content=content or "",
        image_path=image_path,
        timestamp=datetime.now(),
        is_read=False
    )
    db.add(msg)
    db.commit()
    db.refresh(msg)
    return {"success": True, "message_id": msg.id}
```

#### 2. 管理员回复消息（后端API）
```python
@app.post("/admin/reply")
async def admin_reply_message(
    request: Request,
    to_user_id: int = Form(...),
    content: str = Form(None),
    image: UploadFile = File(None),
    db: Session = Depends(get_db)
):
    user = get_current_user(request, db)
    if not user or user.username != 'admin':
        raise HTTPException(status_code=403, detail="只有管理员可以回复消息")
    # ...检查目标用户、保存图片、内容校验...
    msg = Message(
        from_user_id=user.id,
        to_user_id=to_user_id,
        content=content or "",
        image_path=image_path,
        timestamp=datetime.now(),
        is_read=False
    )
    db.add(msg)
    db.commit()
    db.refresh(msg)
    return {"success": True, "message_id": msg.id}
```

#### 3. 获取消息列表（后端API）
```python
@app.get("/messages/list")
async def get_messages(request: Request, db: Session = Depends(get_db), peer_id: int = None, limit: int = 50):
    user = get_current_user(request, db)
    if not user:
        raise HTTPException(status_code=401, detail="请先登录")
    # ...获取与peer_id的所有消息...
    return [{
        "id": m.id,
        "from_user_id": m.from_user_id,
        "to_user_id": m.to_user_id,
        "content": m.content,
        "image_url": f"/chat_images/{os.path.basename(m.image_path)}" if m.image_path else None,
        "timestamp": m.timestamp.isoformat(),
        "is_read": m.is_read
    } for m in msgs]
```

#### 4. 前端调用示例（JS片段）
```js
// 用户发送消息
async function sendMessage() {
    const formData = new FormData();
    formData.append('to_user_id', adminId);
    if (input.value.trim()) formData.append('content', input.value.trim());
    if (imageInput.files[0]) formData.append('image', imageInput.files[0]);
    await fetch('/messages/send', {method:'POST', body:formData});
    // ...刷新聊天记录...
}

// 管理员回复消息
async function adminReply(userId, content, imageFile) {
    const formData = new FormData();
    formData.append('to_user_id', userId);
    if (content) formData.append('content', content);
    if (imageFile) formData.append('image', imageFile);
    await fetch('/admin/reply', {method:'POST', body:formData});
    // ...刷新聊天记录...
}
```

---

## 系统亮点

- **多用户隔离上传目录**：每个用户的上传资料互不干扰，安全可靠。
- **AI多模式生成**：支持融合/区分两种报告生成方式，满足不同需求。
- **智能插图与图片管理**：图片上传即归档，AI自动插图，图片永久可访问。
- **自动格式修正**：报告生成后自动调用Agent修正格式，极大提升一致性。
- **模板灵活扩展**：支持自定义Word模板，自动识别并替换占位符。
- **高并发支持**：生产环境推荐多进程部署，支持高并发访问。
- **支付集成**：对接爱发电平台，自动识别订单并充值使用次数。
- **详细日志与异常处理**：便于问题追踪和维护。
- **内置通讯系统**：用户可随时通过导航栏与管理员在线沟通，管理员可在后台统一回复，支持图片和文字消息，极大提升服务体验。

---

## 技术栈与开发工具

- **后端**：FastAPI、SQLAlchemy、SQLite
- **前端**：HTML5、CSS3、JavaScript（原生/少量jQuery）
- **AI服务**：OpenAI API、千问API
- **文档处理**：python-docx、docxtpl、PyPDF2
- **向量数据库**：ChromaDB
- **认证与安全**：Passlib、Python-Jose
- **部署**：Uvicorn、Gunicorn、Nginx、Docker（可选）
- **开发辅助**：VSCode/PyCharm、Postman、curl

---

## 系统结构

```
├── app.py                 # FastAPI主应用
├── templates/             # 前端HTML模板
│   └── index.html         # 主页
├── static/                # 静态资源（CSS/JS/图片）
├── uploads/               # 用户上传资料（按用户ID隔离）
├── report_images/         # 图片归档目录（按用户ID隔离，报告和前端长期访问）
├── user_templates/        # 用户自定义模板
├── logs/                  # 日志文件
├── requirements.txt       # Python依赖
├── .env                   # 环境变量
└── ...                    # 其它辅助脚本与配置
```

---

## 核心代码片段

### 1. 用户隔离上传目录（后端）

```python
@app.post("/upload")
async def upload_files(
    request: Request,
    cover_template: UploadFile = File(None),
    body_template: UploadFile = File(None),
    files: list[UploadFile] = File([]),
    db: Session = Depends(get_db)
):
    user = get_current_user(request, db)
    if not user:
        raise HTTPException(status_code=401, detail="请先登录")
    user_dir = f"uploads/{user.id}"
    os.makedirs(user_dir, exist_ok=True)
    # 文件保存逻辑...
```

### 2. 智能插图与图片归档（后端核心实现）

```python
# 1. 图片上传时自动归档到 report_images/用户ID/
report_image_dir = Path(f"report_images/{user.id}")
report_image_dir.mkdir(parents=True, exist_ok=True)
for file in data_files:
    if file and hasattr(file, 'filename') and file.filename:
        file_path = user_dir / file.filename
        # ...保存文件...
        if file.filename.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp')):
            # 归档图片
            dst_path = report_image_dir / file.filename
            shutil.copy(file_path, dst_path)
            # 生成图片描述（用大模型）
            description = await get_image_description(str(file_path), ext)
            # 记录图片信息，webpath用于前端和报告插图
            uploaded_images.append({
                'id': img_id,
                'filename': file.filename,
                'description': description,
                'filepath': f"{user.id}/{file.filename}",
                'webpath': f"report_images/{user.id}/{file.filename}"
            })

# 2. 构造图片信息，传递给AI
image_info = ""
if uploaded_images:
    image_info = "\n\n【可用图片】：\n"
    for img in uploaded_images:
        image_info += f"- {img['id']}: {img['filename']} - {img['description']}\n"
    image_info += "\n请在合适的位置使用图片占位符格式：{{image:img_x}}，其中x为图片编号。\n"

# 3. 生成报告正文，AI会自动插入 {{image:img_x}} 占位符
report_body = await ai_service.generate_report_with_prompt(query, prompt+image_info, target_pages_int)

# 4. 渲染/下载报告时，所有图片路径均为 /report_images/用户ID/图片名，前端和Word文档均可长期访问
```

### 3. 报告格式自动检查与修正（Agent后处理核心实现）

```python
# 1. 构造格式修正Prompt
format_fix_prompt = f"""你是一位文档格式检查与修复助手。请对以下报告内容进行格式检查和修正，要求：\n\n1. 标题层级规范\n2. 图片占位符 {{image:img_x}} 必须单独成段，并在下方补充一句图片描述（如有描述信息）\n3. 列表、编号、代码块等符号符合Markdown规范\n4. 删除多余空行和非法符号\n5. 不要改动正文内容，只做格式修正\n\n【报告内容】：\n{report_body}\n"""

# 2. 调用AI进行格式修正
report_body = await ai_service.generate_report_with_prompt(query, format_fix_prompt)

# 3. 用修正后的report_body渲染Word文档和前端，保证格式规范
```

### 4. 模板占位符自动替换

```python
tpl = DocxTemplate(body_template_file)
tpl.render(context_dict)  # context_dict包含所有占位符字段
tpl.save(body_docx)
```

### 5. 前端文件上传与排序（JS片段）

```js
function processFiles(files, type) {
    files.forEach(file => {
        // ...校验
        addFileToList(file, type);
        uploadedFiles[type].push(file);
        if (type === 'data') setTimeout(() => enableDataFileDragSort(), 100);
    });
}
```

### 8. 通讯功能（消息中心）

#### 1. 用户发送消息（后端API）
```python
@app.post("/messages/send")
async def send_message(
    request: Request,
    content: str = Form(None),
    image: UploadFile = File(None),
    to_user_id: int = Form(...),
    db: Session = Depends(get_db)
):
    user = get_current_user(request, db)
    if not user:
        raise HTTPException(status_code=401, detail="请先登录")
    # ...检查目标用户、保存图片、内容校验...
    msg = Message(
        from_user_id=user.id,
        to_user_id=to_user_id,
        content=content or "",
        image_path=image_path,
        timestamp=datetime.now(),
        is_read=False
    )
    db.add(msg)
    db.commit()
    db.refresh(msg)
    return {"success": True, "message_id": msg.id}
```

#### 2. 管理员回复消息（后端API）
```python
@app.post("/admin/reply")
async def admin_reply_message(
    request: Request,
    to_user_id: int = Form(...),
    content: str = Form(None),
    image: UploadFile = File(None),
    db: Session = Depends(get_db)
):
    user = get_current_user(request, db)
    if not user or user.username != 'admin':
        raise HTTPException(status_code=403, detail="只有管理员可以回复消息")
    # ...检查目标用户、保存图片、内容校验...
    msg = Message(
        from_user_id=user.id,
        to_user_id=to_user_id,
        content=content or "",
        image_path=image_path,
        timestamp=datetime.now(),
        is_read=False
    )
    db.add(msg)
    db.commit()
    db.refresh(msg)
    return {"success": True, "message_id": msg.id}
```

#### 3. 获取消息列表（后端API）
```python
@app.get("/messages/list")
async def get_messages(request: Request, db: Session = Depends(get_db), peer_id: int = None, limit: int = 50):
    user = get_current_user(request, db)
    if not user:
        raise HTTPException(status_code=401, detail="请先登录")
    # ...获取与peer_id的所有消息...
    return [{
        "id": m.id,
        "from_user_id": m.from_user_id,
        "to_user_id": m.to_user_id,
        "content": m.content,
        "image_url": f"/chat_images/{os.path.basename(m.image_path)}" if m.image_path else None,
        "timestamp": m.timestamp.isoformat(),
        "is_read": m.is_read
    } for m in msgs]
```

#### 4. 前端调用示例（JS片段）
```js
// 用户发送消息
async function sendMessage() {
    const formData = new FormData();
    formData.append('to_user_id', adminId);
    if (input.value.trim()) formData.append('content', input.value.trim());
    if (imageInput.files[0]) formData.append('image', imageInput.files[0]);
    await fetch('/messages/send', {method:'POST', body:formData});
    // ...刷新聊天记录...
}

// 管理员回复消息
async function adminReply(userId, content, imageFile) {
    const formData = new FormData();
    formData.append('to_user_id', userId);
    if (content) formData.append('content', content);
    if (imageFile) formData.append('image', imageFile);
    await fetch('/admin/reply', {method:'POST', body:formData});
    // ...刷新聊天记录...
}
```

---

## 快速启动

1. 安装依赖
    ```bash
    pip install -r requirements.txt
    ```
2. 配置环境变量（.env）
3. 启动服务（开发模式）
    ```bash
    uvicorn app:app --host 0.0.0.0 --port 8000 --reload
    ```
4. 生产部署（推荐多进程）
    ```bash
    uvicorn app:app --host 0.0.0.0 --port 8000 --workers 4
    ```

---

## 常见问题与解决

- **多用户文件串用？**  
  已通过用户ID隔离上传目录，彻底解决。
- **AI生成慢/失败？**  
  检查API Key与网络，查看logs/app.log获取详细报错。
- **模板不生效？**  
  检查模板文件格式与占位符是否正确。
- **图片不显示/丢失？**  
  请确保图片已归档到 report_images/，并检查图片路径是否正确。
- **报告格式不规范？**  
  系统已自动调用Agent修正格式，如仍有问题可调整Prompt或手动修订。

---

## 联系与支持

如需定制开发、部署支持或遇到BUG，欢迎联系开发团队。

---

如需更详细的API接口文档、二次开发说明或部署脚本，请随时告知！ 