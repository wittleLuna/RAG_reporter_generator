import os
import asyncio
import requests
from pathlib import Path

def create_test_files():
    """åˆ›å»ºæµ‹è¯•æ–‡ä»¶"""
    test_files = [
        ("machine_learning.md", """# æœºå™¨å­¦ä¹ åŸºç¡€

æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦åˆ†æ”¯ï¼Œå®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨æ²¡æœ‰æ˜ç¡®ç¼–ç¨‹çš„æƒ…å†µä¸‹å­¦ä¹ å’Œæ”¹è¿›ã€‚

## ç›‘ç£å­¦ä¹ 
ç›‘ç£å­¦ä¹ ä½¿ç”¨æ ‡è®°çš„è®­ç»ƒæ•°æ®æ¥å­¦ä¹ è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚å¸¸è§çš„ç®—æ³•åŒ…æ‹¬ï¼š
- çº¿æ€§å›å½’
- é€»è¾‘å›å½’
- å†³ç­–æ ‘
- æ”¯æŒå‘é‡æœº

## æ— ç›‘ç£å­¦ä¹ 
æ— ç›‘ç£å­¦ä¹ å¤„ç†æ²¡æœ‰æ ‡ç­¾çš„æ•°æ®ï¼Œç›®æ ‡æ˜¯å‘ç°æ•°æ®ä¸­çš„éšè—æ¨¡å¼ã€‚ä¸»è¦æ–¹æ³•åŒ…æ‹¬ï¼š
- èšç±»åˆ†æ
- é™ç»´æŠ€æœ¯
- å…³è”è§„åˆ™å­¦ä¹ 

## æ·±åº¦å­¦ä¹ 
æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªå­é›†ï¼Œä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥æ¨¡æ‹Ÿäººè„‘çš„å­¦ä¹ è¿‡ç¨‹ã€‚å®ƒåœ¨å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†ç­‰é¢†åŸŸå–å¾—äº†çªç ´æ€§è¿›å±•ã€‚"""),
        
        ("data_analysis.txt", """æ•°æ®åˆ†ææ˜¯æ•°æ®ç§‘å­¦çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œæ¶‰åŠæ”¶é›†ã€æ¸…ç†ã€è½¬æ¢å’Œå»ºæ¨¡æ•°æ®çš„è¿‡ç¨‹ã€‚

## æ•°æ®é¢„å¤„ç†
æ•°æ®é¢„å¤„ç†æ˜¯æ•°æ®åˆ†æçš„ç¬¬ä¸€æ­¥ï¼ŒåŒ…æ‹¬ï¼š
1. æ•°æ®æ¸…æ´—ï¼šå¤„ç†ç¼ºå¤±å€¼ã€å¼‚å¸¸å€¼å’Œé‡å¤æ•°æ®
2. æ•°æ®è½¬æ¢ï¼šæ ‡å‡†åŒ–ã€å½’ä¸€åŒ–ã€ç¼–ç åˆ†ç±»å˜é‡
3. ç‰¹å¾å·¥ç¨‹ï¼šåˆ›å»ºæ–°ç‰¹å¾ã€é€‰æ‹©é‡è¦ç‰¹å¾

## æ¢ç´¢æ€§æ•°æ®åˆ†æ
æ¢ç´¢æ€§æ•°æ®åˆ†æï¼ˆEDAï¼‰å¸®åŠ©ç†è§£æ•°æ®çš„åŸºæœ¬ç‰¹å¾ï¼š
- æè¿°æ€§ç»Ÿè®¡
- æ•°æ®å¯è§†åŒ–
- ç›¸å…³æ€§åˆ†æ
- åˆ†å¸ƒåˆ†æ

## ç»Ÿè®¡å»ºæ¨¡
ç»Ÿè®¡å»ºæ¨¡ä½¿ç”¨æ•°å­¦æ–¹æ³•æè¿°æ•°æ®ä¹‹é—´çš„å…³ç³»ï¼š
- å›å½’åˆ†æ
- æ—¶é—´åºåˆ—åˆ†æ
- å‡è®¾æ£€éªŒ
- ç½®ä¿¡åŒºé—´ä¼°è®¡"""),
        
        ("python_programming.md", """# Pythonç¼–ç¨‹å®è·µ

Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œä»¥å…¶ç®€æ´çš„è¯­æ³•å’Œä¸°å¯Œçš„åº“ç”Ÿæ€ç³»ç»Ÿè€Œé—»åã€‚

## åŸºç¡€è¯­æ³•
Pythonçš„åŸºç¡€è¯­æ³•ç‰¹ç‚¹ï¼š
- ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºä»£ç å—
- åŠ¨æ€ç±»å‹ç³»ç»Ÿ
- é¢å‘å¯¹è±¡ç¼–ç¨‹æ”¯æŒ
- å‡½æ•°å¼ç¼–ç¨‹ç‰¹æ€§

## æ•°æ®å¤„ç†åº“
Pythonåœ¨æ•°æ®å¤„ç†æ–¹é¢æœ‰å¼ºå¤§çš„åº“æ”¯æŒï¼š
- NumPyï¼šæ•°å€¼è®¡ç®—åŸºç¡€åº“
- Pandasï¼šæ•°æ®åˆ†æå’Œæ“ä½œ
- Matplotlibï¼šæ•°æ®å¯è§†åŒ–
- Scikit-learnï¼šæœºå™¨å­¦ä¹ ç®—æ³•

## å®é™…åº”ç”¨
Pythonåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ï¼š
1. æ•°æ®ç§‘å­¦å’Œæœºå™¨å­¦ä¹ 
2. Webå¼€å‘å’ŒAPIæ„å»º
3. è‡ªåŠ¨åŒ–å’Œè„šæœ¬ç¼–å†™
4. ç§‘å­¦è®¡ç®—å’Œä»¿çœŸ""")
    ]
    
    # ç¡®ä¿uploadsç›®å½•å­˜åœ¨
    os.makedirs("uploads", exist_ok=True)
    
    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    for filename, content in test_files:
        file_path = Path("uploads") / filename
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶: {filename}")

async def test_generation_modes():
    """æµ‹è¯•èåˆæ¨¡å¼å’ŒåŒºåˆ†æ¨¡å¼"""
    
    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    print("1. åˆ›å»ºæµ‹è¯•æ–‡ä»¶...")
    create_test_files()
    
    # æµ‹è¯•èåˆæ¨¡å¼
    print("\n2. æµ‹è¯•èåˆæ¨¡å¼...")
    await test_mode("fusion", "èåˆæ¨¡å¼")
    
    # æµ‹è¯•åŒºåˆ†æ¨¡å¼
    print("\n3. æµ‹è¯•åŒºåˆ†æ¨¡å¼...")
    await test_mode("separate", "åŒºåˆ†æ¨¡å¼")

async def test_mode(mode, mode_name):
    """æµ‹è¯•æŒ‡å®šçš„ç”Ÿæˆæ¨¡å¼"""
    
    url = "http://localhost:8000/generate_report"
    
    data = {
        "query": "åŸºäºä¸Šä¼ çš„èµ„æ–™ï¼Œç”Ÿæˆä¸€ä»½å…³äºæ•°æ®ç§‘å­¦å’Œæœºå™¨å­¦ä¹ çš„å®è®­æŠ¥å‘Š",
        "name": "å¼ ä¸‰",
        "student_id": "2021001",
        "class_name": "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯1ç­",
        "instructor": "æè€å¸ˆ",
        "project_name": "æ•°æ®ç§‘å­¦å®è®­é¡¹ç›®",
        "generation_mode": mode
    }
    
    try:
        print(f"  æ­£åœ¨æµ‹è¯•{mode_name}...")
        response = requests.post(url, data=data)
        result = response.json()
        
        if result.get("filename"):
            print(f"  âœ… {mode_name}æµ‹è¯•æˆåŠŸï¼")
            print(f"  ğŸ“„ æ–‡ä»¶å: {result['filename']}")
            print(f"  ğŸ“ ç”Ÿæˆæ¨¡å¼: {result.get('generation_mode', 'æœªçŸ¥')}")
            
            # æ˜¾ç¤ºæŠ¥å‘Šé¢„è§ˆ
            report_preview = result.get("report", "")[:200] + "..." if len(result.get("report", "")) > 200 else result.get("report", "")
            print(f"  ğŸ“‹ æŠ¥å‘Šé¢„è§ˆ: {report_preview}")
            
        else:
            print(f"  âŒ {mode_name}æµ‹è¯•å¤±è´¥: {result.get('detail', 'æœªçŸ¥é”™è¯¯')}")
            
    except requests.exceptions.ConnectionError:
        print(f"  âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿åº”ç”¨æ­£åœ¨è¿è¡Œ")
    except Exception as e:
        print(f"  âŒ {mode_name}æµ‹è¯•å¤±è´¥: {e}")

def main():
    """ä¸»å‡½æ•°"""
    print("=== ç”Ÿæˆæ¨¡å¼åŠŸèƒ½æµ‹è¯• ===\n")
    
    # æµ‹è¯•åŠŸèƒ½
    asyncio.run(test_generation_modes())
    
    print("\n=== æµ‹è¯•å®Œæˆ ===")

if __name__ == "__main__":
    main() 