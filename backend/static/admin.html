<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>后台管理</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h2 { margin-top: 0; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 24px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f0f0f0; }
        .hidden { display: none; }
        .btn { padding: 4px 12px; border: none; background: #1976d2; color: #fff; border-radius: 4px; cursor: pointer; }
        .btn:disabled { background: #aaa; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; }
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; }
        .logout { float: right; color: #1976d2; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <div id="login-box">
        <h2>管理员登录</h2>
        <div class="form-group">
            <label>用户名</label>
            <input type="text" id="login-username">
        </div>
        <div class="form-group">
            <label>密码</label>
            <input type="password" id="login-password">
        </div>
        <button class="btn" onclick="login()">登录</button>
        <div id="login-error" style="color:red;"></div>
    </div>

    <div id="admin-panel" class="hidden">
        <span class="logout" onclick="logout()">退出登录</span>
        <h2>用户管理</h2>
        <table id="user-table">
            <thead>
            <tr><th>ID</th><th>用户名</th><th>邮箱</th><th>剩余次数</th><th>注册时间</th><th>操作</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="user-edit-box" class="hidden">
            <h3>编辑用户</h3>
            <div class="form-group">
                <label>邮箱</label>
                <input type="text" id="edit-email">
            </div>
            <div class="form-group">
                <label>剩余次数</label>
                <input type="number" id="edit-usage">
            </div>
            <div class="form-group">
                <label>新密码（留空不修改）</label>
                <input type="password" id="edit-password">
            </div>
            <button class="btn" onclick="saveUserEdit()">保存</button>
            <button class="btn" onclick="closeUserEdit()" style="background:#aaa;">取消</button>
        </div>
        <div id="order-box" class="hidden">
            <h3>用户购买记录</h3>
            <table id="order-table">
                <thead>
                <tr><th>订单号</th><th>金额</th><th>备注</th><th>时间</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <button class="btn" onclick="closeOrderBox()" style="background:#aaa;">关闭</button>
        </div>
    </div>
</div>
<script>
let token = localStorage.getItem('admin_token') || '';
let currentEditUserId = null;

function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }

function login() {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    fetch('/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
    }).then(r => r.json()).then(res => {
        if (res.access_token) {
            token = res.access_token;
            localStorage.setItem('admin_token', token);
            hide('login-box');
            show('admin-panel');
            loadUsers();
        } else {
            document.getElementById('login-error').innerText = res.detail || '登录失败';
        }
    }).catch(() => {
        document.getElementById('login-error').innerText = '网络错误';
    });
}

function logout() {
    token = '';
    localStorage.removeItem('admin_token');
    hide('admin-panel');
    show('login-box');
}

function loadUsers() {
    fetch('/admin/users', {
        headers: { 'Authorization': 'Bearer ' + token }
    }).then(r => {
        if (r.status === 401) { logout(); return []; }
        return r.json();
    }).then(users => {
        const tbody = document.querySelector('#user-table tbody');
        tbody.innerHTML = '';
        users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.id}</td><td>${u.username}</td><td>${u.email||''}</td><td>${u.usage_count}</td><td>${u.created_at.replace('T',' ').slice(0,19)}</td><td><button class='btn' onclick='editUser(${u.id})'>编辑</button> <button class='btn' onclick='viewOrders(${u.id})' style='background:#43a047;'>订单</button></td>`;
            tbody.appendChild(tr);
        });
    });
}

function editUser(id) {
    fetch(`/admin/user/${id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
    }).then(r => r.json()).then(u => {
        currentEditUserId = id;
        document.getElementById('edit-email').value = u.email||'';
        document.getElementById('edit-usage').value = u.usage_count;
        document.getElementById('edit-password').value = '';
        show('user-edit-box');
    });
}
function saveUserEdit() {
    const email = document.getElementById('edit-email').value;
    const usage_count = parseInt(document.getElementById('edit-usage').value);
    const password = document.getElementById('edit-password').value;
    fetch(`/admin/user/${currentEditUserId}`, {
        method: 'PUT',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, usage_count, password: password || undefined })
    }).then(r => r.json()).then(res => {
        hide('user-edit-box');
        loadUsers();
    });
}
function closeUserEdit() { hide('user-edit-box'); }

function viewOrders(id) {
    fetch(`/admin/user/${id}/orders`, {
        headers: { 'Authorization': 'Bearer ' + token }
    }).then(r => r.json()).then(orders => {
        const tbody = document.querySelector('#order-table tbody');
        tbody.innerHTML = '';
        orders.forEach(o => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${o.out_trade_no}</td><td>${o.amount}</td><td>${o.remark||''}</td><td>${o.created_at.replace('T',' ').slice(0,19)}</td>`;
            tbody.appendChild(tr);
        });
        show('order-box');
    });
}
function closeOrderBox() { hide('order-box'); }

// 自动登录
if (token) {
    hide('login-box');
    show('admin-panel');
    loadUsers();
}
</script>
</body>
</html> 